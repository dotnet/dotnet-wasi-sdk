#include <string.h>
#include <mono-wasi/driver.h>
#include <mono/metadata/assembly.h>

// This symbol's implementation is generated during the build
const char* dotnet_wasi_getentrypointassemblyname();

// These are generated by EmitWasmBundleObjectFile
const char* dotnet_wasi_getbundledfile(const char* name, int* out_length);
void dotnet_wasi_registerbundledassemblies();

// TODO: This should actually go in driver.c in the runtime
void mono_marshal_ilgen_init() {}

#ifdef WASI_AFTER_RUNTIME_LOADED_DECLARATIONS
// This is supplied from the MSBuild itemgroup @(WasiAfterRuntimeLoaded)
WASI_AFTER_RUNTIME_LOADED_DECLARATIONS
#endif

int main(int argc, char* argv[]) {
    dotnet_wasi_registerbundledassemblies();

    mono_wasm_load_runtime("", 0);

#ifdef WASI_AFTER_RUNTIME_LOADED_CALLS
    // This is supplied from the MSBuild itemgroup @(WasiAfterRuntimeLoaded)
    WASI_AFTER_RUNTIME_LOADED_CALLS
#endif

    MonoArray* args = mono_wasm_string_array_new(argc - 1);
    MonoDomain* domain = mono_object_get_domain((MonoObject*)args);
    for (int i = 1; i < argc; i++)
    {
        // Exclude first arg as that is the application name as is not passed in dotnet applications.
        mono_array_set(args, MonoString*, i - 1, mono_string_new(domain, argv[i]));
    }
    void* entry_method_params[] = { args };

    MonoAssembly* assembly = mono_assembly_open(dotnet_wasi_getentrypointassemblyname(), NULL);
    MonoMethod* entry_method = mono_wasm_assembly_get_entry_point(assembly);
    MonoObject* out_exc = NULL;
    mono_wasm_invoke_method(entry_method, NULL, entry_method_params, &out_exc);

    // Note: if the return value isn't an int (e.g., it's async main, returning a Task)
    // then the following will result in an obscure error.
    // TODO: Handle all entrypoint method types
    // return mono_unbox_int(exit_code);
    return out_exc ? 1 : 0;
}
